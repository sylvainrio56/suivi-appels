<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Contact - Yeastar P520</title>
    <style>
        :root {
            --primary: #0056b3;
            --secondary: #6c757d;
            --success: #28a745;
            --bg: #f4f7f9;
            --white: #ffffff;
            --danger: #d9534f;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .main-container {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 25px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid #e1e4e8;
            height: fit-content;
        }

        h2 { margin-top: 0; color: var(--primary); font-size: 1.3rem; border-bottom: 2px solid var(--bg); padding-bottom: 10px; margin-bottom: 20px; }

        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; background-color: var(--primary); color: white; margin-top: 10px; }
        button:hover { background-color: #004494; }

        /* Dashboard Stats */
        .stats-grid { display: flex; gap: 10px; margin-bottom: 20px; }
        .stat-item { flex: 1; padding: 10px; border-radius: 8px; text-align: center; color: #fff; font-weight: bold; }
        .bg-devis { background: var(--success); }
        .bg-depan { background: var(--danger); }
        .bg-suivi { background: var(--primary); }
        .stat-val { font-size: 1.2rem; display: block; }

        /* Historique */
        .search-box { background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; text-align: left; padding: 12px; border-bottom: 2px solid #dee2e6; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: top; }
        .tag-objet { color: var(--primary); font-weight: bold; display: block; font-size: 0.8rem; }
        .btn-call { background: var(--success); color: white; padding: 5px 10px; text-decoration: none; border-radius: 4px; font-size: 0.8rem; }

        #statusMsg { margin-top: 10px; padding: 10px; border-radius: 6px; display: none; text-align: center; }

        @media (max-width: 900px) { .main-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="main-container">
    
    <div class="card">
        <h2>Appel Entrant</h2>
        <form id="contactForm">
            <div class="form-group">
                <label>Nom du Contact</label>
                <input type="text" id="nom" placeholder="Nom..." required>
            </div>
            <div class="form-group">
                <label>Num√©ro de T√©l√©phone</label>
                <input type="tel" id="tel" placeholder="+33..." required>
            </div>
            <div class="form-group">
                <label>Objet de l'appel</label>
                <select id="objet">
                    <option value="Suivi de dossier">Suivi de dossier</option>
                    <option value="Demande de devis">Demande de devis</option>
                    <option value="Demande de D√©pannage">Demande de D√©pannage</option>
                </select>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="note" placeholder="Compte-rendu..."></textarea>
            </div>
            <button type="submit" id="btnSubmit">ENREGISTRER</button>
        </form>
        <div id="statusMsg"></div>
    </div>

    <div class="card">
        <h2>Tableau de Bord & Historique</h2>
        
        <div class="stats-grid">
            <div class="stat-item bg-depan"><small>D√©pannages</small><span class="stat-val" id="statDep">0</span></div>
            <div class="stat-item bg-devis"><small>Devis</small><span class="stat-val" id="statDevis">0</span></div>
            <div class="stat-item bg-suivi"><small>Suivis</small><span class="stat-val" id="statSuivi">0</span></div>
        </div>

        <div class="search-box">
            <input type="text" id="searchInput" placeholder="üîç Rechercher un client..." onkeyup="filtrerHistorique()">
        </div>

        <div id="loader" style="text-align:center;">Chargement...</div>
        
        <table id="historyTable">
            <thead>
                <tr>
                    <th>Contact</th>
                    <th>Note</th>
                    <th>Date</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="historyBody"></tbody>
        </table>
    </div>
</div>

<script>
    // 1. URL SCRIPT GOOGLE
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyH6fgzNVnNnUfiQWZ8B_7wZjejd4ndV0A0HkxUKlWXUnSwh5Y5NPUakPdtevq7s8IY/exec';

    // 2. REMONT√âE AUTOMATIQUE
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        let tel = urlParams.get('callerid');
        let nom = urlParams.get('displayname');

        if (tel && !tel.includes('{')) {
            document.getElementById('tel').value = tel.trim();
            document.getElementById('searchInput').value = tel.trim();
        }
        if (nom && !nom.includes('{')) {
            document.getElementById('nom').value = decodeURIComponent(nom).replace(/\+/g, ' ').trim();
        }

        chargerHistorique();
    };

    // 3. CHARGEMENT (HISTORIQUE + STATS)
    async function chargerHistorique() {
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL);
            const res = await response.json();
            
            // On s√©pare les donn√©es re√ßues du script Google
            const data = res.history; 
            const stats = res.stats;

            // Mise √† jour des compteurs
            if(stats) {
                document.getElementById('statDep').innerText = stats.depannage || 0;
                document.getElementById('statDevis').innerText = stats.devis || 0;
                document.getElementById('statSuivi').innerText = stats.suivi || 0;
            }

            const body = document.getElementById('historyBody');
            document.getElementById('loader').style.display = 'none';
            body.innerHTML = '';

            data.slice(-20).reverse().forEach(row => {
                const tr = document.createElement('tr');
                const dateShort = new Date(row.date).toLocaleDateString('fr-FR');
                tr.innerHTML = `
                    <td><strong>${row.nom}</strong><br><small>${row.tel}</small></td>
                    <td><span class="tag-objet">[${row.objet}]</span>${row.note}</td>
                    <td><small>${dateShort}</small></td>
                    <td><a href="tel:${row.tel}" class="btn-call">Appeler</a></td>
                `;
                body.appendChild(tr);
            });

            // Une fois charg√©, on filtre si un num√©ro est pr√©sent
            filtrerHistorique();

        } catch (e) {
            console.error(e);
            document.getElementById('loader').innerText = "Erreur de chargement.";
        }
    }

    // 4. FILTRE
    function filtrerHistorique() {
        const filter = document.getElementById("searchInput").value.toUpperCase();
        const tr = document.getElementById("historyTable").getElementsByTagName("tr");
        for (let i = 1; i < tr.length; i++) {
            const td = tr[i].getElementsByTagName("td")[0];
            tr[i].style.display = (td && td.innerText.toUpperCase().includes(filter)) ? "" : "none";
        }
    }

    // 5. ENVOI
    document.getElementById('contactForm').onsubmit = async function(e) {
        e.preventDefault();
        const btn = document.getElementById('btnSubmit');
        btn.disabled = true;
        
        const data = {
            nom: document.getElementById('nom').value,
            tel: document.getElementById('tel').value,
            objet: document.getElementById('objet').value,
            note: document.getElementById('note').value
        };

        fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) })
        .then(() => {
            alert("‚úì Enregistr√© !");
            document.getElementById('note').value = "";
            chargerHistorique();
        })
        .finally(() => btn.disabled = false);
    };
</script>
</body>
</html>
