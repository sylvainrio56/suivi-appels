<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Console Contact Yeastar x Sheets</title>
    <style>
        :root { --primary: #0066cc; --success: #28a745; --bg: #f0f2f5; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 1000px; }
        .card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        h2 { color: var(--primary); margin-top: 0; border-bottom: 2px solid var(--bg); padding-bottom: 10px; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #444; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { opacity: 0.9; }
        
        #status { margin-top: 10px; padding: 10px; border-radius: 4px; display: none; text-align: center; }
        
        /* Style de l'historique */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; }
        .badge { padding: 2px 6px; border-radius: 4px; background: #e9ecef; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>Saisie d'Appel</h2>
        <form id="contactForm">
            <div class="form-group">
                <label>Nom / Entreprise</label>
                <input type="text" id="nom" required placeholder="Nom r√©cup√©r√© ou saisi...">
            </div>
            <div class="form-group">
                <label>Num√©ro de t√©l√©phone</label>
                <input type="tel" id="tel" required placeholder="06...">
            </div>
            <div class="form-group">
                <label>Note / Motif de l'appel</label>
                <textarea id="note" rows="4" placeholder="R√©sum√© de la conversation..."></textarea>
            </div>
            <button type="submit" id="submitBtn">ENREGISTRER LA FICHE</button>
        </form>
        <div id="status"></div>
    </div>

    <div class="card">
        <h2>Derniers Contacts</h2>
        <div id="loader">Chargement de la base partag√©e...</div>
        <table id="historyTable">
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Note</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody id="historyBody"></tbody>
        </table>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzROyfp5kO5ILX3Wnp2Hwz75bIU1VehjoDQstUTGgFdHvnAORGA79GeQhAsuVyBl9GcZA/exec';

    // 1. GESTION DU SCREEN POP (Yeastar)
    // URL attendue : index.html?callerid=0612345678&displayname=JeanDupont
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('callerid')) {
            document.getElementById('tel').value = urlParams.get('callerid');
        }
        if (urlParams.has('displayname')) {
            document.getElementById('nom').value = urlParams.get('displayname');
        }
        chargerHistorique(); // Charger les donn√©es existantes au d√©marrage
    };

    // 2. ENVOI DES DONN√âES (Vers Google Sheets)
    document.getElementById('contactForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        const status = document.getElementById('status');
        
        btn.disabled = true;
        btn.innerText = "Synchronisation...";

        const payload = {
            nom: document.getElementById('nom').value,
            tel: document.getElementById('tel').value,
            note: document.getElementById('note').value
        };

        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify(payload)
        })
        .then(() => {
            status.style.display = 'block';
            status.style.background = '#d4edda';
            status.innerText = "Fiche enregistr√©e avec succ√®s !";
            this.reset();
            setTimeout(chargerHistorique, 2000); // Rafra√Æchir l'historique
        })
        .catch(err => {
            status.innerText = "Erreur de connexion.";
            console.error(err);
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerText = "ENREGISTRER LA FICHE";
        });
    });

    // 3. R√âCUP√âRATION DE L'HISTORIQUE (Depuis Google Sheets)
    async function chargerHistorique() {
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL + "?action=read");
        const data = await response.json();
        const body = document.getElementById('historyBody');
        document.getElementById('loader').style.display = 'none';
        body.innerHTML = '';

        // On prend les 10 derniers contacts
        data.slice(-10).reverse().forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><b>${row.nom}</b><br><small>${row.tel}</small></td>
                <td>${row.note}</td>
                <td>
                    <a href="tel:${row.tel}" style="text-decoration:none;">
                        <button style="padding:5px 10px; background:#28a745; width:auto; font-size:0.8rem;">
                            üìû Appeler
                        </button>
                    </a>
                </td>
            `;
            body.appendChild(tr);
        });
    } catch (e) {
        document.getElementById('loader').innerText = "Historique indisponible.";
    }
}
</script>

</body>
</html>